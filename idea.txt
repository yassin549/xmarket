# Xmarket — Core Concept & Architecture

**Platform Name**: Xmarket  
**Slogan**: "Trade Everything"

**Xmarket** is a trading platform that combines:
- **Polymarket's philosophy**: Enable trading on any event, trend, or concept
- **Stock market mechanics**: Continuous price discovery, long/short positions, leverage, perpetual contracts
- **Creator economy**: Anyone can create markets and earn fees

**Core Innovation**: Instead of binary prediction markets (yes/no outcomes), we create **perpetual sentiment contracts** that continuously reflect collective valuation of anything - events, trends, people, ideas, assets, etc.

**Platform Type**: Investment/Trading platform (not a betting platform)

---

## 1) Core Concept: What is a "Stock" in Everything Market?

A **"Stock"** (or **"Market"**) in Everything Market is a **perpetual sentiment contract** that represents the collective market's valuation of a specific subject. Unlike traditional stocks (ownership) or prediction markets (binary outcomes), our stocks are:

- **Perpetual**: No expiry date, continuously tradable
- **Sentiment-based**: Price reflects collective belief/valuation, not ownership rights
- **Universal**: Can represent anything (events, people, trends, assets, concepts)
- **Leverageable**: Can go long (bullish) or short (bearish) with margin

**Examples:**
- "Stock" for "Will AI replace software engineers by 2030?" → Price reflects probability (0-100%)
- "Stock" for "Taylor Swift's cultural influence" → Price reflects sentiment score (0-100)
- "Stock" for "Bitcoin adoption rate" → Price reflects expected adoption percentage
- "Stock" for "Climate change impact severity" → Price reflects expected severity index

---

## 2) Market Types (Clarified)

### Type A: **Event Markets** (Time-bound, Resolvable)
- **Definition**: Markets about events that will resolve at a specific time
- **Example**: "Will X win the election?" → Resolves to YES (100.0) or NO (0.0)
- **Pricing**: Price = market's estimated probability (0.0 to 100.0)
- **Resolution**: Oracle-based resolution at event time
- **Valuation**: Price converges to 100.0 or 0.0 as resolution approaches

### Type B: **Sentiment Markets** (Perpetual, Subjective) — **MVP FOCUS**
- **Definition**: Markets about subjective concepts that don't have clear resolution
- **Example**: "Taylor Swift's cultural influence" → Continuous sentiment score
- **Pricing**: Price = market's collective sentiment index (0.0 to 100.0)
- **Resolution**: No resolution - perpetual trading
- **Valuation**: Price reflects ongoing sentiment, can fluctuate indefinitely

### Type C: **Index Markets** (Perpetual, Data-driven)
- **Definition**: Markets tied to external data sources (like traditional indices)
- **Example**: "Bitcoin adoption rate" → Tracks actual adoption metrics
- **Pricing**: Price = normalized index value (e.g., 0-100 scale)
- **Resolution**: No resolution - perpetual trading
- **Valuation**: Price anchored to external data via oracles, but can diverge based on sentiment

**Recommendation**: Start with **Type B (Sentiment Markets)** for MVP, as they're most aligned with "bet on everything" philosophy and don't require complex oracle resolution.

---

## 3) How Valuation Works

### The Core Question: What Does Price Represent?

For **Sentiment Markets** (our primary focus):
- **Price = Collective Sentiment Index**
- Price of 50.0 = neutral sentiment
- Price of 100.0 = extremely positive sentiment
- Price of 0.0 = extremely negative sentiment
- Price movement = changing collective belief

### Price Discovery Mechanism

1. **Initial Price**: Set by creator (e.g., 50.0 for neutral start)
2. **Price Discovery**: Through trading activity
   - More buyers → price increases (bullish sentiment)
   - More sellers → price decreases (bearish sentiment)
3. **Liquidity Model**: 
   - **AMM (Constant Product)**: For new/small markets
   - **Orderbook**: For high-volume markets
4. **Funding Rate**: Keeps price anchored when there's imbalance
   - If longs > shorts → longs pay shorts (discourages over-optimism)
   - If shorts > longs → shorts pay longs (discourages over-pessimism)

### Example: "AI Will Replace Software Engineers by 2030"

- **Initial Price**: 50.0 (50% probability)
- **Trader A buys** (thinks it's likely) → Price moves to 52.0
- **Trader B shorts** (thinks it's unlikely) → Price moves to 51.0
- **Price of 51.0** = Market collectively believes 51% probability
- **As 2030 approaches**: Price will converge toward 0.0 or 100.0 based on reality

---

## 4) Market Creation Flow

**Step 1: Creator Proposes Market**
- Title: "Will AI replace software engineers by 2030?"
- Description: Clear explanation of what's being valued
- Market Type: Event Market (resolvable) vs Sentiment Market (perpetual)
- Initial Price: Default 50.0 (neutral) or creator-specified
- Resolution Date: (For Event Markets only) - when market resolves
- Resolution Criteria: (For Event Markets) - how to determine outcome

**Step 2: Platform Validation**
- Check for duplicates
- Verify clarity and compliance
- Assess spam/abuse risk
- Require minimum seed liquidity (e.g., $1,000 USDC)

**Step 3: Market Initialization**
- Create market record in database
- Initialize AMM pool with seed liquidity
- Set initial reserves: `R_quote = seed_amount`, `R_base = seed_amount / initial_price`
- Example: If seed = $10,000 and initial_price = 50.0:
  - `R_quote = 10,000 USDC`
  - `R_base = 200 shares` (10,000 / 50.0)
  - Constant product: `k = 10,000 * 200 = 2,000,000`

**Step 4: Market Goes Live**
- Market appears in feed
- Trading begins immediately
- Creator earns fee share (20-50% of trading fees)

---

## 5) Trading Mechanics

### Long Position (Bullish)
- **Action**: Buy shares (expect price to increase)
- **Mechanism**: Swap USDC for shares via AMM
- **Example**: Buy 10 shares at price 50.0 → Cost = 500 USDC (with slippage)
- **Profit**: If price rises to 60.0, sell 10 shares → Receive ~600 USDC → Profit = ~100 USDC

### Short Position (Bearish)
- **Action**: Sell shares (expect price to decrease)
- **Mechanism**: Use perpetual-style contracts (recommended for MVP)
- **Perpetual Short**: Open short position with margin, pay funding if shorts > longs

### Leverage
- **Leverage 2x**: Use $500 margin to control $1,000 position
- **Leverage 5x**: Use $200 margin to control $1,000 position
- **Risk**: Higher leverage = lower liquidation price
- **Liquidation**: When price moves against you and margin is insufficient

---

## 6) Pricing Engine — Hybrid Design

**Why hybrid?**
- Long-tail markets: AMM (cheap & composable)
- High-volume creator markets: orderbook/perpetual engine for tight spreads & advanced order types

**Architecture**
- `TradeGateway` (Node) receives orders/UI events → `MatchingEngine` (Rust/Go) for orderbook markets → writes fills to Kafka → `PositionsService` updates P&L in Postgres & Redis
- AMM markets: On-chain-style CPMM calculations run in backend (off-chain) for speed; maintain reserves in DB/events

---

## 7) AMM Math + Example (Corrected)

Use **constant-product AMM** for MVP.

Let:
- `R_quote` = quote reserve (USDC)
- `R_base` = base reserve (shares)
- `k = R_quote * R_base` (constant product)
- price = `R_quote / R_base` (quote per share)

**Example** (showing exactly how price moves when someone buys 10 shares):

1. Start reserves:
   - `R_quote = 10,000` USDC
   - `R_base = 200` shares
   - `k = 10,000 * 200 = 2,000,000`
   - Current price = `10,000 / 200 = 50.0 USDC per share`

2. A trader wants to buy 10 shares:
   - Target: `R_base_new = R_base - 10 = 200 - 10 = 190 shares`
   - Calculate required USDC: `R_quote_new = k / R_base_new = 2,000,000 / 190 = 10,526.32 USDC`
   - `ΔQ = R_quote_new - R_quote = 10,526.32 - 10,000 = 526.32 USDC`

3. Apply fee (0.25%):
   - Fee = 526.32 * 0.0025 = 1.32 USDC
   - User pays: 526.32 + 1.32 = 527.64 USDC
   - Protocol receives: 1.32 * 0.2 = 0.26 USDC (20% of fee)
   - LPs receive: 1.32 * 0.8 = 1.06 USDC (80% of fee)

4. Update reserves:
   - `R_quote = 10,526.32`
   - `R_base = 190`
   - New price = `10,526.32 / 190 = 55.40 USDC per share`
   - Price impact = `(55.40 - 50.0) / 50.0 = 10.8%`

**Interpretation:** With reserves of 10k/200, buying 10 shares moves price 10.8%. For tighter slippage, seed larger reserves or use orderbook.

---

## 8) Funding Rate Engine (Critical for Perpetual Markets)

**Purpose**: Keep price discovery healthy and prevent manipulation

**Formula**:
```
OI_long = Total open interest on long positions ($)
OI_short = Total open interest on short positions ($)
OI_total = OI_long + OI_short

imbalance = (OI_long - OI_short) / OI_total
funding_rate = clamp(imbalance * k, -max_rate, +max_rate)

Where:
- k = sensitivity constant (0.01 recommended)
- max_rate = maximum funding rate per period (0.01 = 1% per 8 hours)
```

**Numeric example**:
- `OI_long = 1,200,000`
- `OI_short = 800,000`
- `OI_total = 2,000,000`
- `imbalance = (1,200,000 - 800,000) / 2,000,000 = 0.2` (20% more longs)
- `funding_rate = 0.2 * 0.01 = 0.002` (0.2% per 8 hours)
- **Result**: Longs pay shorts 0.2% of their position value every 8 hours

**Why This Matters**: 
- If everyone is bullish (many longs), funding rate makes it expensive to stay long
- Encourages shorts to enter, balancing the market
- Prevents price from being manipulated by one-sided sentiment

**Clamp**: Always `funding_rate := max(min(funding_rate, +0.01), -0.01)` to avoid runaway.

---

## 9) Liquidity Strategy

- **Seed pool**: Platform seed USDC to AMMs for initial liquidity per new market (configurable)
- **Creator liquidity incentives**: Give creators a split of fees & LP rewards for first N days
- **Protocol market makers (PMMs)**: Automated bots that keep spread tight on orderbook markets for trending creators (runs on servers)
- **Liquidity mining**: Reward LPs with your platform token (if you choose tokenomics later) or revenue share

**Initial reserves guidance**
- For viral culture markets: start with `R_quote = $100k` for AMM to keep slippage reasonable
- For niche markets: `R_quote = $10k` is OK
- Minimum seed: $1,000 USDC

---

## 10) Fees & Revenue Model

- Maker fee: 0.05% (orderbook)
- Taker fee: 0.15%
- AMM swap fee: 0.25% (split: 80% LPs, 20% protocol)
- Market creation fee: small pay-to-create or free + deposit for spam prevention
- Creator fee share: 20–50% of market fees (default 30%, max 50%, decays 5% every 30 days, min 10%)
- Platform revenue funds insurance pool & operations

---

## 11) Risk Controls & Market Safety

- **Max leverage**: default 3x for public markets (MVP), up to 5x for vetted markets (Phase 2)
- **Maintenance margin**: e.g., 5% for 5x leverage, sliding scale
- **Liquidations**: forced when margin < maintenance, with partial close + liquidation penalty (fees to insurance fund)
- **Insurance fund**: funded by fees & creator penalties to cover insolvencies
- **Auto-Deleveraging fallback** (ADL) for extreme cases
- **Circuit breakers**: when price moves > X% in Y seconds (configurable e.g., 25% in 30s), pause matching for that market
- **Oracle safeguards**: multiple sources + median, rate-limits, staleness checks. If manipulation suspected, pause
- **Creator restrictions**: Can't trade their own markets for first 7 days

---

## 12) UX / Core Flows

### 1. Discover Markets (Landing Page)
- Hero: "Trade Everything"
- Trending markets (by volume, price change, new)
- Categories: Politics, Sports, Culture, Tech, etc.
- Search bar with autocomplete
- Market cards: Title, price, 24h change, volume, quick Long/Short buttons

### 2. Market Detail Page
- Header: Title, creator, tags, share/embed buttons
- Price Chart: Real-time price line, volume bars, time range selector (1h, 24h, 7d, 30d, All)
- Trading Panel:
  - Current price (large, prominent)
  - Long/Short toggle
  - Amount input (USDC or shares)
  - Leverage slider (1x to 5x)
  - Price impact preview
  - Funding rate display
  - Risk warning
  - "Place Order" button
- Market Info: Description, resolution criteria (if event), creator info, recent trades, open positions

### 3. Create Market (Wizard)
- Step 1: What are you creating? (Title, description, category, market type)
- Step 2: Market Parameters (Initial price, resolution date/criteria if event, creator fee %)
- Step 3: Seed Liquidity (Amount, slippage preview for $100/$1k/$10k)
- Step 4: Review & Submit (Preview, terms, submit)

### 4. Portfolio/Dashboard
- Overview: Total value, unrealized P&L, realized P&L (24h, 7d, 30d, All), available balance
- Positions: Active positions (Market, Side, Entry/Current Price, P&L, Leverage, Liquidation Price), quick actions
- Trade History: All trades, filterable
- Created Markets: Your markets, volume, fees earned

### 5. Follow/Share
- One-click share to X/Twitter, embeddable mini-widget (price, buy button)

---

## 13) Design System Principles

### Visual Identity
- **Trustworthy Finance Aesthetic**: Clean, professional, data-dense but readable
- **Color Palette**:
  - Primary: Deep blue/purple (trust, finance)
  - Success: Green (profits, bullish)
  - Danger: Red (losses, bearish)
  - Neutral: Gray scale for backgrounds
- **Typography**: 
  - Headings: Bold, clear hierarchy
  - Numbers: Monospace font for prices/amounts
  - Body: Readable sans-serif

### Component Library
- **Price Display**: Large, prominent, color-coded (green up, red down)
- **Chart Component**: Line chart, candlestick option, volume bars, interactive tooltips
- **Trade Modal**: Slide-up on mobile, centered on desktop, real-time price impact, confirmation step
- **Market Card**: Hover effects, quick actions, responsive grid

### Mobile-First
- One-handed operation: Key actions accessible with thumb
- Bottom navigation: Home, Markets, Create, Portfolio, Profile
- Swipe gestures: Close modals, swipe between markets
- Touch targets: Minimum 44x44px
- Simplified charts on mobile

### UX Patterns
- **Real-time Updates**: WebSocket for live prices, optimistic UI, toast notifications
- **Risk Communication**: Clear warnings ("You can lose your entire margin"), liquidation price, funding rate display, visual risk indicators
- **Onboarding**: Welcome screen, tutorial (swipeable cards), demo market, first trade guidance

---

## 14) Creator Economy & Virality

- Creators open markets on their own topics → earn fee share (30% default, up to 50%)
- Allow creators to **sponsor** or **boost** their markets in feeds
- Social referral bonuses: if you bring a trader who trades $X volume, you get % of fees for 30 days
- Widgets for embedding markets on external sites (small JS widget)
- Leaderboards, public portfolios (opt-in), and copy-trade feature to follow top predictors

---

## 15) Compliance & Legal Guardrails

- **Geofence** countries with strict derivatives/permitted laws (U.S., depending on features). For MVP, geofence US and other high-risk jurisdictions
- Use **terms**: "sentiment exchange", "forecasting instrument", not "stocks" or "securities"
- KYC thresholds: KYC only above certain withdraw or trading volume thresholds (e.g., > $10k)
- AML monitoring: suspicious activity alerts
- Legal counsel review before launch

---

## 16) Data Model (Key Schemas)

### Market Schema
```typescript
interface Market {
  id: string;
  slug: string;
  title: string;
  description: string;
  category: string[];
  tags: string[];
  
  // Market Type
  market_type: 'event' | 'sentiment' | 'index';
  
  // Pricing
  initial_price: Decimal; // e.g., 50.0
  current_price: Decimal; // Derived from AMM reserves
  price_scale: { min: number; max: number }; // e.g., { min: 0, max: 100 }
  
  // Resolution (for event markets)
  resolution_date?: Date;
  resolution_criteria?: string;
  resolution_outcome?: 'yes' | 'no' | null;
  resolved_at?: Date;
  
  // Liquidity
  liquidity_model: 'amm' | 'orderbook' | 'hybrid';
  amm_reserve_quote: Decimal; // USDC
  amm_reserve_base: Decimal; // Shares
  amm_constant_k: Decimal; // k = R_quote * R_base
  
  // Creator
  creator_id: string;
  creator_fee_pct: number; // 20-50%
  
  // Trading
  status: 'draft' | 'live' | 'paused' | 'resolved' | 'closed';
  total_volume: Decimal;
  open_interest_long: Decimal;
  open_interest_short: Decimal;
  
  // Metadata
  created_at: Date;
  updated_at: Date;
}
```

### Position Schema
```typescript
interface Position {
  id: string;
  user_id: string;
  market_id: string;
  
  // Position Details
  side: 'long' | 'short';
  entry_price: Decimal;
  current_price: Decimal;
  size: Decimal; // Notional value in USDC
  leverage: number; // 1x to 5x
  margin: Decimal; // Collateral
  
  // P&L
  pnl_unrealized: Decimal;
  pnl_realized: Decimal;
  
  // Risk
  liquidation_price: Decimal;
  maintenance_margin: Decimal;
  
  // Funding (for perpetuals)
  funding_paid: Decimal;
  last_funding_calc: Date;
  
  // Status
  status: 'open' | 'closed' | 'liquidated';
  opened_at: Date;
  closed_at?: Date;
}
```

---

## 17) Critical Questions Answered

### Q1: How do we value a stock?
**Answer**: For **Sentiment Markets** (our primary focus):
- Price = Collective sentiment index (0-100 scale)
- Price discovery through trading (supply/demand)
- Funding rate prevents one-sided manipulation
- No "intrinsic value" - purely market-driven sentiment

**For Event Markets**:
- Price = Market's estimated probability (0-100%)
- Converges to 0% or 100% as resolution approaches
- Oracle resolves at event time

### Q2: How do we create a stock?
**Answer**: 
1. Creator proposes market (title, description, type, initial price)
2. Platform validates (duplicates, compliance, clarity)
3. Creator seeds liquidity (min $1,000 USDC)
4. Market initializes with AMM pool
5. Market goes live, trading begins
6. Creator earns fee share (20-50% of trading fees)

### Q3: What is a stock?
**Answer**: A **perpetual sentiment contract** representing collective market valuation of a subject. It's:
- **Not ownership** (unlike traditional stocks)
- **Not a binary bet** (unlike prediction markets)
- **A continuous sentiment index** that can be traded long/short with leverage

---

## 18) Risk Mitigation

### Market Manipulation
- Circuit breakers (pause if >25% move in 30s)
- Funding rate (discourages one-sided positions)
- Minimum liquidity requirements
- Monitoring & alerts for unusual activity
- Creator restrictions (can't trade their own markets for first 7 days)

### Liquidity Issues
- Minimum seed liquidity ($1,000)
- Platform seeding for popular markets
- AMM → Orderbook migration when volume grows
- Clear slippage warnings in UI

### Regulatory Risks
- Legal counsel before launch
- Geofencing (block restricted jurisdictions)
- Clear terms: "Sentiment exchange", not "securities"
- KYC/AML for high-volume users
- Compliance monitoring

### Technical Risks
- Extensive testing (unit, integration, simulation)
- Code audits (especially financial logic)
- Immutable audit logs
- Insurance fund for insolvencies
- Regular backups & disaster recovery

---

## 19) Success Metrics

### Product Metrics
- DAU/MAU of traders
- Markets Created: New markets per week
- Trading Volume: Daily volume in USDC
- Open Interest: Total value of open positions
- Retention: Day 7, Day 30 retention rates

### Financial Metrics
- Revenue: Trading fees collected
- Creator Earnings: Fees paid to creators
- Insurance Fund: Balance & sufficiency ratio
- Platform Profit: Revenue - costs - creator fees

### Quality Metrics
- Slippage: Average price impact per trade
- Liquidation Rate: % of positions liquidated
- Uptime: Platform availability (target: 99.9%)
- Latency: Trade execution time (target: <200ms)

---

## 20) Key Insights

**Xmarket** is fundamentally about **continuous sentiment discovery** - enabling the crowd to collectively value anything through real-money trading, with no expiration dates (for sentiment markets) and no binary outcomes required.

**Core Innovation**: We're not building a prediction market (binary outcomes) or a traditional stock exchange (ownership). We're building a **perpetual sentiment exchange** where anything can be continuously valued by the market.

---

## 21) Payment & Wallet System (Custodial Architecture)

### 21.1 Custodial Wallet System

**Architecture**: Xmarket uses a **custodial wallet system** where the platform manages all user funds. Users do NOT need to connect external wallets (MetaMask, Coinbase Wallet, etc.). This simplifies onboarding and provides a seamless trading experience similar to Polymarket.

**Key Principles**:
- Users deposit funds directly to platform-managed addresses
- Platform holds funds in secure hot/cold wallets
- Users see a unified USD balance (all stablecoins converted to USD equivalent)
- Instant withdrawals without platform permission (fully automated)
- No wallet connection required for MVP

### 21.2 Multi-Stablecoin Support

**Supported Stablecoins** (Like Polymarket):
- **USDC** (USD Coin) - Primary
  - Networks: Ethereum, Polygon, Base, Arbitrum, Optimism, Avalanche
- **USDT** (Tether)
  - Networks: Ethereum, Polygon, Base, Arbitrum, Optimism
- **DAI** (Dai Stablecoin)
  - Networks: Ethereum, Polygon, Base
- **PYUSD** (PayPal USD)
  - Networks: Ethereum, Base

**MVP Priority**: Start with USDC (Ethereum + Polygon), USDT (Ethereum + Polygon), DAI (Ethereum + Polygon)

### 21.3 Deposit System

**Unified Deposit Portal**:
- Single interface where users can deposit any supported stablecoin
- Token selector: USDC, USDT, DAI, PYUSD
- Network selector: Ethereum, Polygon, Base, etc.
- Unique deposit address per user/token/network combination
- QR code for easy mobile scanning
- Copy address button

**Deposit Flow**:
1. User selects token (e.g., USDC) and network (e.g., Polygon)
2. System generates/retrieves unique deposit address for that user/token/network
3. User sends stablecoin from their wallet to deposit address
4. Alchemy webhook detects incoming transaction
5. Backend verifies transaction (token, network, amount, confirmations)
6. Get token price from CoinGecko (for USD conversion)
7. Credit user wallet (unified USD balance)
8. Notify user (email + in-app)

**Deposit Address Management**:
- Each user gets unique addresses per token/network
- Format: `deposit_{user_id}_{token}_{network}`
- Addresses stored in `UserDepositAddress` table
- All addresses monitored via Alchemy webhooks

### 21.4 Withdrawal System (Instant & Automated)

**Key Principle**: Users can withdraw instantly without platform permission - fully automated system.

**Withdrawal Flow**:
1. User enters amount, token, network, withdrawal address
2. System validates (balance, limits, address format)
3. **Immediate debit** from user balance (optimistic update)
4. Withdrawal queued for processing
5. Automated worker checks hot wallet balance
6. Replenish from cold storage if needed
7. Send transaction via Alchemy
8. Monitor confirmation
9. Update status: "processing" → "completed"
10. Notify user

**Hot Wallet Management**:
- Hot wallets for each token/network combination
- Keep sufficient balance for instant withdrawals (e.g., $50k per token/network)
- Auto-replenish from cold storage when balance < threshold
- Monitor balances and alert when low

**Withdrawal Limits (MVP)**:
- Minimum: $10 USD equivalent
- Daily: $1,000 (unverified), $10,000 (verified)
- Weekly: $5,000 (unverified), $50,000 (verified)
- Note: Can remove limits later for true instant withdrawals

### 21.5 Unified Balance System

**Single USD Balance**:
- Users see one unified balance in USD
- All deposits (USDC, USDT, DAI, etc.) converted to USD equivalent
- All trading uses USD equivalent
- Withdrawals can be in any supported stablecoin

**Conversion**:
- Use CoinGecko API for real-time token prices
- Update prices every 5 minutes
- Store USD value at time of deposit/withdrawal
- Example: User deposits 100 USDC → Stored as $100 USD (if 1 USDC = $1)

**Benefits**:
- Simpler UX (one balance to track)
- Easy to understand
- Works like traditional trading platforms
- Users can deposit any stablecoin, trade, withdraw any stablecoin

### 21.6 API Integrations

#### Alchemy (Primary - Blockchain Infrastructure)
- **Purpose**: Deposit detection, transaction monitoring, withdrawal execution
- **Features**:
  - Multi-chain support (Ethereum, Polygon, Base, Arbitrum, Optimism, Avalanche)
  - Webhook notifications for address activity
  - Enhanced APIs (getAssetTransfers, getTokenBalances)
  - Transaction simulation
- **Setup**: 
  - Create Alchemy account (free tier sufficient for MVP)
  - Create apps for each network
  - Set up webhooks for deposit detection
  - Point webhooks to: `POST /webhooks/alchemy`
- **Documentation**: https://docs.alchemy.com/
- **Cost**: Free tier (300M compute units/month), then pay-as-you-go

#### CoinGecko API (Token Prices)
- **Purpose**: Real-time token prices for USD conversion
- **Features**:
  - Real-time prices for all stablecoins
  - Historical price data
  - Multi-chain support
- **Setup**:
  - Sign up at https://www.coingecko.com/en/api
  - Get API key
  - Use for converting deposits/withdrawals to USD
- **Documentation**: https://www.coingecko.com/en/api/documentation
- **Cost**: Free tier (10-50 calls/min), paid for higher limits

#### TradingView Lightweight Charts
- **Purpose**: Real-time price charts, candlesticks, volume bars
- **Features**:
  - High-performance rendering
  - Customizable themes
  - Multiple chart types (line, candlestick, area, histogram)
  - Time range selection
  - Mobile-responsive
- **Setup**: 
  - Install: `npm install lightweight-charts`
  - No external API needed - consumes your own data
- **Documentation**: https://tradingview.github.io/lightweight-charts/
- **Cost**: Free (open-source)

### 21.7 Database Schema Additions

```prisma
model UserDepositAddress {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  token         String   // "USDC", "USDT", "DAI", "PYUSD"
  network       String   // "ethereum", "polygon", "base", etc.
  address       String   @unique // Unique deposit address
  
  createdAt     DateTime @default(now())
  lastUsedAt    DateTime?
  
  deposits      Deposit[]
}

model Deposit {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  depositAddressId String
  depositAddress UserDepositAddress @relation(fields: [depositAddressId], references: [id])
  
  token         String
  network       String
  amount        Decimal  @db.Decimal(18, 6)
  usdValue      Decimal  @db.Decimal(18, 2) // USD equivalent at time of deposit
  
  txHash        String   @unique
  blockNumber   BigInt
  confirmations Int      @default(0)
  
  status        String   // "pending", "confirming", "completed", "failed"
  
  createdAt     DateTime @default(now())
  completedAt   DateTime?
}

model Withdrawal {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  token         String
  network       String
  amount        Decimal  @db.Decimal(18, 6)
  usdValue      Decimal  @db.Decimal(18, 2) // USD equivalent at time of withdrawal
  address       String   // User's withdrawal address
  
  txHash        String?
  blockNumber   BigInt?
  confirmations Int      @default(0)
  
  status        String   // "pending", "processing", "completed", "failed"
  
  createdAt     DateTime @default(now())
  completedAt   DateTime?
}

model HotWallet {
  id            String   @id @default(uuid())
  token         String
  network       String
  address       String   @unique
  balance       Decimal  @db.Decimal(18, 6)
  minBalance    Decimal  @db.Decimal(18, 6) // Alert threshold
  maxBalance    Decimal  @db.Decimal(18, 6) // Max before moving to cold
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Wallet {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])
  
  // Unified balance (USD equivalent)
  balanceUSD   Decimal  @default(0) @db.Decimal(18, 2)
  
  // Ledger
  ledgerEntries WalletLedgerEntry[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model WalletLedgerEntry {
  id            String   @id @default(uuid())
  walletId      String
  wallet        Wallet   @relation(fields: [walletId], references: [id])
  
  type          String   // "deposit", "withdrawal", "trade", "fee", "funding"
  direction     String   // "credit", "debit"
  amount        Decimal  @db.Decimal(18, 6) // Token amount
  usdValue      Decimal  @db.Decimal(18, 2) // USD equivalent
  token         String   // "USDC", "USDT", "DAI", etc.
  network       String   // "ethereum", "polygon", "base", etc.
  balanceAfter  Decimal  @db.Decimal(18, 2) // USD balance after
  
  // Transaction details
  txHash        String?
  blockNumber   BigInt?
  
  // Metadata
  metadata      Json?
  
  createdAt     DateTime @default(now())
}
```

### 21.8 Security & Compliance

**Custodial Wallet Security**:
- Platform holds user funds in secure hot/cold wallets
- Hot wallets: For instant withdrawals (limited balance, e.g., $50k per token/network)
- Cold wallets: For majority of funds (offline, multi-sig recommended)
- Regular security audits
- Insurance fund for insolvency protection

**Transaction Security**:
- Automated withdrawal processing (no manual approval needed)
- Transaction monitoring (Alchemy, Tenderly)
- Audit logs for all financial actions
- Hot wallet balance monitoring
- Automatic cold storage replenishment

**Geofencing**:
- Block users from restricted countries (US, etc.)
- IP-based detection (MaxMind GeoIP)
- User-declared residency check

**KYC/AML** (Optional for MVP):
- KYC only if:
  - Trading volume > $10k
  - Withdrawal > $5k
  - Suspicious activity detected
- Integration with KYC providers (Persona, Onfido) - Phase 2
