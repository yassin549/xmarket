# Rules, details & principles for building *Everything Market* with **Antigravity Create**

Below is a single canonical policy you can drop into your repo and use as the authoritative rulebook for **Antigravity agents**, human contributors, CI, operations, and the platform runtime. It is concise where possible, prescriptive where necessary, and explicit about *what must never happen* (especially with respect to markets, seeding, and data integrity).

> Use this as `docs/antigravity-rules.md` in your repository and enforce it via CI, pre-commit hooks, and runtime guards.

---

# 1. High-level policy (one sentence)

All Antigravity agents and automated processes must operate as *assistants* to human operators, never autonomously create or publish real markets/stocks/indexes/events, never seed demo or production markets with fabricated market content, and always produce auditable, signed actions that humans must approve before final publication.

---

# 2. Hard prohibitions (non-negotiable)

1. **No autonomous creation of markets/stocks/indexes/events.**

   * Antigravity agents must never create or commit new market items, indexes, or trading instruments without an explicit, recorded human admin approval (`admin_decision`) stored in the audit log.
2. **No seeding of market data in production or staging.**

   * Agents must never add synthetic trades, prices, indexes, or any fabricated time-series to any production or staging database, repository, or demo environment.
3. **No secrets or credentials in code.**

   * Agents must not create, store or commit secrets in repositories, PR descriptions, or logs. Use vaults and Vercel secrets only.
4. **No bypassing human-in-loop checks for sensitive flows** (political/economic markets, admin actions, emergency overrides).
5. **No external outbound actions without signed authorization.**

   * If an agent needs to call third-party APIs on behalf of the org (e.g., purchase a resource), it must produce a signed request that a human operator must authorize.

Violation of any of the above triggers immediate quarantine and audit (see runbook).

---

# 3. Antigravity agent rules (behavioral & operational)

Agents are allowed to *propose, analyze, draft, and test* — but must not finalize or publish sensitive state. Rules below:

## 3.1 Agent capabilities (what they *may* do)

* **Draft PRs**: create code PRs with tests and documentation, but their PRs must be labelled `agent-proposal` and require at least one human reviewer with `admin` rights to merge.
* **Generate design docs & specs**: produce `docs/` content, architecture diagrams, JSON schemas, and test data **only** in the `sandbox` directory or local dev fixtures (never in `staging`/`production` datasets).
* **Create tests & CI configs**: produce unit/integration tests and CI workflows. Tests that rely on external credentials must be disabled and flagged `manual-run`.
* **Make measurable recommendations**: compute resource estimates, cost projections, performance tests with sample inputs.
* **Run safe mock simulations**: run end-to-end simulations using synthetic data **only** in isolated CI environments flagged for agent use. All synthetic datasets must be tagged and deterministic.

## 3.2 Agent forbidden behaviors (operational)

* **No merges**: agents may create PRs, but cannot merge into `main` or `production` branches.
* **No production admin actions**: cannot flip feature flags, modify secrets, or change infra settings.
* **No seeding or fabricating real user or market data**: any generated data must be clearly labeled `SYNTHETIC` and must never be routed into staging or production stores.
* **No acting as human**: agents cannot impersonate humans in audit logs, commit authorship, or generated `admin_decision` events. Every admin decision must be created by a human authenticated admin user.
* **No automatic LLM-initiated external requests** that incur financial cost (e.g., spinning GPU hosts) without human approval.

## 3.3 Agent input & output contract

* **Inputs**: all inputs to agents must be sanitized and annotated with source and `snapshot_id` where applicable.
* **Outputs**: must contain a `producer` field with agent id, a `confidence` score, generated `diffs` (if code), and a `safety_assertions` block that states how the output adheres to prohibitions above. Example output header:

```json
{
  "producer":"antigravity/create:v1.2.3",
  "ts":"2025-11-24T10:00:00Z",
  "confidence":0.87,
  "safety_assertions":["no-seed-data","no-production-write","requires-human-merge"],
  "artifacts":[...]
}
```

Agents must always attach `safety_assertions`.

---

# 4. Human-in-the-loop workflows (exact steps)

Every sensitive operation follows these steps:

## 4.1 Creation of a market/index (required)

1. **Agent (optional) proposes**: creates a `market_proposal` document in `docs/proposals/` with `metadata`, `sources[]` (list of snapshot_ids), risk assessment, and recommended `type` (political/economic/social/...). Label PR `agent-proposal` or `human-proposal`.
2. **Human reviewer**: an admin reviews, optionally adjusts, and adds `review_decision` in PR comments.
3. **Human approval action**: admin makes an **explicit admin API call** (or clicks UI) that creates `admin_decision` audit_event with fields: `{admin_id, decision, rationale, ts, signature}`.
4. **Finalizer**: backend receives signed admin decision and only then executes database write to create market. The write is recorded as `audit_event` and included in the append-only audit table.

## 4.2 LLM-driven candidate events (reality pipeline)

1. `reality-worker` proposes `candidate_event` (includes `snapshot_ids` and source metadata).
2. If the event is low-risk (pre-approved ruleset) it may auto-finalize; else it goes to the human review queue.
3. For `political` and `economic` types: require human approval (single admin or multi-sig depending on risk_level).
4. When human approves, the action is logged with `admin_decision` and only then published to `events` and broadcasted.

---

# 5. Audit, provenance & immutability (technical)

1. **Audit events**: every state-changing API must write an `audit_event` row:
   `{event_id, action, actor_id, actor_type (human|agent), ts, payload_hash, signature (if agent), job_id}`.
2. **Snapshot-based provenance**: all ingested external content must produce a `snapshot_id = sha256(url + "|" + fetched_iso_ts)` and raw snapshot saved to object store at `snapshots/{snapshot_id}.html`. LLM outputs must reference `snapshot_id`s only.
3. **Append-only logs**: `audit_event` table is append-only (no DELETE without legal workflow). Older audits can be archived to cold storage but remain immutable.
4. **Tamper-evidence**: HMAC or signature for audit entries; store public keys / key-ids to validate later.

---

# 6. Idempotency & job lifecycle (how agents must schedule work)

1. **Idempotency key rule**: every external or scheduled job must include `idempotency_key` and `job_type`. Agents must generate keys deterministically for identical jobs to avoid duplicates.
2. **Jobs table**: central `jobs` table must track `{job_id, idempotency_key, job_type, payload, attempts, status, next_attempt_at}`. Agents should create job records via API only (not direct DB).
3. **DLQ & poison handling**: jobs failing > `MAX_ATTEMPTS` (e.g., 5) are moved to DLQ with notification to owners. Agents must not retry DLQ items automatically; human intervention required.
4. **Backoff policy**: exponential backoff with jitter. Agents must implement backoff parameters consistent with org defaults.

---

# 7. HMAC & request signing (inter-service security for agent actions)

1. **Request signature header**:

   * `X-HMAC-KeyId: <key-id>`
   * `X-HMAC-Ts: <ISO8601>`
   * `X-HMAC-Nonce: <uuid-v4>`
   * `X-HMAC-Signature: hex(hmac-sha256(key, method|path|ts|nonce|body))`
2. Agents must include headers when calling internal APIs. Nonces are validated server-side to prevent replay.
3. **Key rotation & storage**: agents should retrieve keys from Vault or Vercel secrets at runtime; keys are never stored in agent state.

---

# 8. PR & repo governance rules for agent-generated code

1. **Labeling:** all agent-created PRs must include label `agent-proposal`.
2. **Mandatory reviewers:** PRs touching `src/orderbook`, `migrations`, `docs/decisions.md`, or `production` infra require at least one `owner` from the relevant team.
3. **CI gates:** PR cannot be merged until:

   * idempotency tests pass (for ingest paths),
   * HMAC header lint passes,
   * LLM schema tests included (if LLM code changed),
   * No secrets in diff.
4. **Merge policy:** only a human may merge `agent-proposal` PRs into `main`. Merges must be signed via Git commit signing or via the admin console action that generates `admin_decision`.
5. **Agent commit metadata:** agents must set a consistent commit signature prefix, e.g., `antigravity/create[v1] - draft` — CI should reject any agent commits that try to impersonate humans.

---

# 9. Runtime enforcement (guards & runtime checks)

1. **Feature flag guard:** any operation that can create markets or admin-level changes must pass a server-side guard that verifies the caller is a human admin and that an `admin_decision` exists. Agents cannot bypass the guard.
2. **Preview deployments:** agent PR preview deployments must use `SANDBOX` configuration (no production DB credentials) and `LLM_MODE=disabled` unless explicitly enabled by an admin.
3. **Production write guard:** a middleware verifies `actor_type` and `admin_decision` before any write to `events`/`markets` tables. If the guard fails, write is blocked and an incident is logged.
4. **Agent quota:** agents are rate-limited in CI and runtime to avoid runaway costs (calls/hr, token usage caps). If agent usage approaches budget thresholds a notification is sent to owners and agent activity is paused.

---

# 10. Observability & alerting (agent-specific)

1. **Agent audit metrics:** every agent should emit metrics: `agent.calls`, `agent.failed_schema`, `agent.safety_assertion_violations`. Alerts fire if `safety_assertion_violations > 0`.
2. **Agent-run incidents:** if an agent causes a failing job to enter DLQ, notify job owner and create a P0 ticket.
3. **Cost alarms:** token usage or LLM spend from agent activity above X% of monthly budget → auto-disable agent writes to production and notify Ops.

---

# 11. Testing & simulation environment (how agents should be run)

1. **Sandbox workspace**: create an isolated `sandbox` environment in CI with:

   * independent database,
   * object store bucket prefixed `sandbox/`,
   * `LLM_MODE=disabled` or uses a community HF sandbox with strict quotas,
   * limited orderbook host with no external connectivity.
2. **Synthetic datasets**: all synthetic data must be deterministic (seeded RNG) and clearly labeled `SYNTHETIC`. Agents must tag any output generated with synthetic data.
3. **Simulation tests**: agents must generate simulation PRs that include run outputs and deterministic fixtures that humans can replay locally.

---

# 12. Human escalation & runbook (immediate actions for violations)

1. **Detection:** any CI policy violation or runtime guard triggered creates an `incident` entry in `incidents` table.
2. **Immediate steps:** set `AGENTS_MODE=paused`, revoke agent keys (rotate), notify Security + Infra + Product via on-call.
3. **Triage:** reproduce event in sandbox, gather logs (`audit_event`), and run rollback if production mutations occurred.
4. **Post-mortem:** mandatory post-mortem written within 72h, with remediation plan and timeline. Store under `ops/postmortems/`.

---

# 13. RBAC & roles (who can do what)

* `viewer`: read-only.
* `editor`: create proposals, modify docs, run sandbox tests.
* `admin`: approve market creation, flip feature flags, run backups, sign `admin_decision`.
* `super-admin`: rotate keys, emergency ops override (requires an additional audit_event + multi-sig if political markets involved).
* Agents: `agent` role (no admin privileges). Agents map to `actor_type=agent` in audit events.

---

# 14. Example agent workflow (template)

1. Agent scans feeds and drafts `candidate_events` with `snapshot_ids` and recommended `type`.
2. Agent opens PR: `docs/proposals/proposal-<slug>.md` and labels `agent-proposal`. PR includes:

   * candidate JSON,
   * `safety_assertions`,
   * reproducible test fixture (`/sandbox/fixtures/<id>.json`).
3. Human reviewer inspects, requests changes or approves.
4. When approved, admin calls `POST /api/v1/admin/action` to create `admin_decision`.
5. Backend verifies `admin_decision` and writes final event with `audit_event`.

---

# 15. CI enforcement checklist (actions for maintainers)

* Add pre-commit hook `check-agent-commit` to ensure agent commits include `agent-producer` metadata and do not claim human authorship.
* Add GitHub Action `agent-policy-check` to validate:

  * PR label correctness,
  * no secrets in diffs,
  * presence of `safety_assertions` in agent PR descriptions,
  * tests for idempotency and HMAC usage where applicable.
* Add runtime middleware `guard-admin-decision` for production writes.

---

# 16. Example safety_assertions (agent must include at output)

* `"no-production-write"`
* `"no-seed-data"`
* `"requires-human-approval"`
* `"uses-snapshot-ids-for-provenance"`

CI rejects outputs missing at least two of these assertions.

---

# 17. Short, shareable policy blurb (for README)

> Antigravity agents are powerful assistants — they may propose code, drafts, and data analyses — but they are strictly **not allowed** to create or publish live markets, seed demo data in production, or perform admin actions. Every sensitive action requires explicit human approval recorded in the audit log.

---

# 18. Implementation checklist (first 7 days)

1. Commit `docs/antigravity-rules.md` to repo.
2. Add `agent-policy-check` GitHub Action + pre-commit hook.
3. Implement `guard-admin-decision` middleware in backend (block writes without `admin_decision`).
4. Create `sandbox` environment in CI and run basic agent simulation.
5. Rotate keys and create agent-specific Vault entries with strict expirations.
6. Create `ops/postmortems/` template and incident creation automation.
7. Add `agent` role in auth system with least privilege.

---

# 19. Final note (ethos)

Antigravity agents accelerate development — but the single overarching constraint is **human accountability**. Keep the chain-of-trust clear: every final action that affects users, markets, legal risk, or money must be auditable, reversible, and explicitly approved by a human. Treat agents as assistants, not decision-makers.

---

If you’d like, I can now:

* generate the full `docs/antigravity-rules.md` file formatted for your repo (with the CI Action YAML and pre-commit hook scripts), **or**
* produce the GitHub Action `agent-policy-check` code and a sample pre-commit hook, **or**
* draft the `admin_decision` API spec and server-side guard middleware code (Node/TS) to enforce the rules.

Pick one and I’ll produce it immediately.
