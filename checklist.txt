
---

# How to use this checklist

1. Convert each bold task into a GitHub Issue with the title, description, acceptance criteria and labels shown below.
2. Create one branch / PR per issue. Use the PR template included (paste into new PR descriptions).
3. Run CI (pytest) on each PR and attach test evidence to PR.
4. Mark `Done` only when all acceptance criteria and tests pass.

---

# Legend

* **Priority:** MUST / SHOULD / NICE
* **Owner:** (team/dev name — fill in)
* **Acceptance:** explicit checks that must pass
* **Test:** automated tests to add before merge
* **Artifact:** file(s) to create / update

---

# Phase 0 — Repo + infra bootstrap (MUST)

1. **Create repo & main branches** — Priority: MUST

   * Task: Create `everything-market` repo on GitHub. Add branches `dev`, `staging`, `main`. Protect `main` & `dev` with PR required.
   * Artifact: `README.md`, `LICENSE`, `.gitignore`
   * Acceptance: repo exists, `dev` branch protected.

2. **Add canonical constants & config** — Priority: MUST

   * Task: Add `config/constants.py` and `config/env.py` with exact constants from `/mnt/data/details.txt`. Export env var names in README.
   * Acceptance: `python -c "import config.constants; print(config.constants.DELTA_CAP)"` prints `20`.
   * Test: unit test that loads constants.

3. **Repo scaffold + CI skeleton** — Priority: MUST

   * Task: Create skeleton folders: `/backend`, `/reality-engine`, `/orderbook`, `/frontend`, `/infra`, `/docs`, `/migrations`. Add `.github/workflows/ci.yml` with pytest and simple lint.
   * Acceptance: PR runs CI (pytest install) and passes install step.
   * Artifact: `infra/docker-compose.yml` with Postgres.

4. **PR & issue templates** — Priority: MUST

   * Add `.github/PULL_REQUEST_TEMPLATE.md` and `.github/ISSUE_TEMPLATE/feature.md` with the PR checklist included below.

---

# Phase 1 — Reality Engine (core ingestion + LLM) (MUST)

Break this into small issues; implement and test each.

1. **sources.yaml + crawler rules** — Priority: MUST

   * Artifact: `reality-engine/sources.yaml` listing top-3 sites with `id,url,trust,crawl_delay`.
   * Acceptance: file present and parsed by `reality-engine/config.py`.
   * Test: unit test that `scraper` respects `crawl_delay` values.

2. **Robots.txt + throttle module** — Priority: MUST

   * Task: Implement `reality-engine/crawler/robots.py` that reads/obeys `robots.txt`.
   * Acceptance: requests blocked if disallowed; `crawl-delay` enforced.
   * Test: mock `robots.txt` server with disallow and assert crawler skips.

3. **Poller + RSS + extraction** — Priority: MUST

   * Artifact: `reality-engine/poller.py` & `scraper_utils.py`. RSS-first, `newspaper3k` fallback, Playwright as last resort. Respect `DATABASE_URL` fallback to sqlite.
   * Acceptance: `python -m reality_engine.poller` produces logs of discovered items without violating robots.
   * Test: unit tests for `fetch_rss_items` and `make_id`.

4. **Embedding wrapper & caching** — Priority: MUST

   * Artifact: `reality-engine/nlp/embed.py` (model loaded once, batching & cache).
   * Acceptance: embedding shape = (384,), dtype float32 and normalized.
   * Test: deterministic embedding test.

5. **FAISS index + TTL eviction** — Priority: MUST

   * Artifact: `reality-engine/index/vector_index.py`. Evict older than 6h.
   * Acceptance: vector queries detect duplicates (similarity > 0.88).
   * Test: add vectors, time-shift, call eviction, confirm removal.

6. **Deterministic quick_scorer** — Priority: MUST

   * Artifact: `reality-engine/nlp/quick_scorer.py` implementing formula exactly (0.4 sentiment, 0.3 keywords, 0.3 NER).
   * Acceptance: outputs in [-1,1].
   * Test: unit tests with known text → expected sign and range.

7. **Grouping / clustering** — Priority: MUST

   * Artifact: clusterer that groups docs at similarity >= 0.78.
   * Acceptance: grouping increases `num_related_docs`.
   * Test: clustering unit test.

8. **tinyLLama runner (deterministic JSON output)** — Priority: MUST

   * Artifact: `reality-engine/llm/llm_runner.py`. Local invocation (binary) and strict JSON schema parse. Token-bucket limiter using env `LLM_CALLS_PER_HOUR`.
   * Acceptance: valid JSON with keys `summary, impact_suggestion, confidence, rationale`.
   * Test: parser test using sample tinyLLama output.

9. **Event builder & HMAC publisher** — Priority: MUST

   * Artifact: `reality-engine/event_builder.py` and `publisher.py`. Compute `event_points` exactly as spec and sign payload with `REALITY_API_SECRET`.
   * Acceptance: backend accepts signed payload and inserts event row (or marks pending).
   * Test: end-to-end integration test (mock backend).

---

# Phase 2 — Orderbook (MUST)

1. **OrderBook engine core** — Priority: MUST

   * Artifact: `orderbook/core.py` implementing price-time priority, partial fills, deterministic trade IDs.
   * Acceptance: unit tests for matching, partial fills, FIFO within price level.
   * Test: deterministic matching tests.

2. **Persistence & recovery** — Priority: MUST

   * Artifact: DB tables `orders`, `trade_history`, snapshot/rebuild logic.
   * Acceptance: restart rebuilds state identically.
   * Test: snapshot then rebuild verify equality.

3. **API endpoints + WS** — Priority: MUST

   * Artifact: FastAPI endpoints and `WS /ws/orders`.
   * Acceptance: `POST /orders` returns order id; trades broadcast via WS.
   * Test: integration test placing orders and receiving WS events.

4. **Market pressure API** — Priority: MUST

   * Endpoint: `GET /api/v1/market/{symbol}/pressure`.
   * Acceptance: returns market_price (0..100), buy/sell volumes, net_pressure.
   * Test: integration test with recent trades/orders.

---

# Phase 3 — Backend & Reality integration (MUST)

1. **DB models & migrations** — Priority: MUST

   * Artifact: `backend/app/models.py` (stocks, scores, events, llm_audit, score_changes, llm_calls). Alembic migrations created.
   * Acceptance: `alembic upgrade head` runs and creates tables.

2. **Ingest endpoint + validation** — Priority: MUST

   * Endpoint: `POST /api/v1/reality/ingest`. Validate signature, event uniqueness, recompute weight defensively.
   * Acceptance: signed events inserted to `events` table or created `llm_audit`.
   * Test: replay test to assert idempotency.

3. **Anti-manipulation module** — Priority: MUST

   * Artifact: `backend/security/antimanip.py`. Implement `cap_single_source_influence`, rolling 24h sum, `SUSPICIOUS_DELTA` check.
   * Acceptance: events >15 points create audit row and set pending flag.
   * Test: unit tests for cap behavior, pending creation.

4. **Blender & atomic apply_event** — Priority: MUST

   * Artifact: `backend/blender.py` & `reality_engine_adapter.py`. Ingest -> call orderbook pressure -> compute final price. Use DB transaction for `score_changes` + `scores` update.
   * Acceptance: final price and score update persisted atomically.
   * Test: DB transaction rollback test on failure.

5. **Admin endpoints** — Priority: MUST

   * Endpoints: `GET /api/v1/admin/pending`, `POST /api/v1/admin/approve`. Protect with `X-ADMIN-KEY`.
   * Acceptance: admin approval applies pending audit and broadcast.
   * Test: protected endpoint auth and approval flow.

6. **WS broadcaster** — Priority: MUST

   * Broadcast `reality_update`, `market_update`, `final_update`, `audit_event`.
   * Acceptance: subscribers receive ordered messages.

---

# Phase 4 — Frontend (MUST)

1. **Base app & auth** — Priority: MUST

   * Implement Vite React app with JWT login (mockable).
   * Acceptance: users can login & get JWT for WS & APIs.

2. **Dashboard & charts** — Priority: MUST

   * Components: `StockDashboard`, `Chart.js` graph with Final series (main), Reality & Market overlays. Local buffering and resync on reconnect.
   * Acceptance: chart displays real-time updates and allows panning.

3. **Orderbook UI & order entry** — Priority: MUST

   * Components: `OrderbookPanel`, order form (limit/market). Integrate with `orderbook` endpoints.
   * Acceptance: order placed updates orderbook UI and triggers server-side match.

4. **Events & Admin UI** — Priority: MUST

   * `EventsPanel` shows event cards with LLM summary & source links. `AdminPanel` allows approving pending audits.
   * Acceptance: admin approves and frontend reflects change.

---

# Phase 5 — Testing, CI, Security (MUST)

1. **Unit tests** — Priority: MUST

   * Add unit tests for all core modules: embed, index eviction, quick_scorer, llm_runner parsing, orderbook matching, blender.
   * Acceptance: all tests pass locally.

2. **Integration tests & end-to-end pipeline** — Priority: MUST

   * Simulate full cycle (2 news items → reality-engine POST → backend applies or audit → backend queries orderbook → final price). Use mocks where needed.
   * Acceptance: CI runs integration test in docker-compose environment.

3. **CI workflows** — Priority: MUST

   * `.github/workflows/ci.yml` run pytest and `python -m compileall .`. `deploy.yml` builds image on `main` and posts comment (no auto-deploy).
   * Acceptance: PR triggers CI.

4. **Security & secrets** — Priority: MUST

   * Secrets: `REALITY_API_SECRET`, `ADMIN_API_KEY` in Railway/GH Secrets only. HMAC verification and `hmac.compare_digest` for keys.
   * Acceptance: secrets not present in code or logs.

---

# Phase 6 — Deploy & Ops (MUST → SHOULD)

1. **Railway services setup** — Priority: MUST

   * Create 4 services on Railway (reality-engine, orderbook, backend, frontend). Add Postgres plugin. Set envs.
   * Acceptance: services deployed; backend can query orderbook; reality-engine posts to backend.

2. **Monitoring & alerts** — Priority: SHOULD

   * Export metrics (LLM calls/hr, events/hr, FAISS memory, orderbook latency). Set alerts for thresholds: LLM > (env) and SUSPICIOUS_DELTA spikes.
   * Acceptance: alerts firing tested (simulate thresholds).

3. **Canary / Safe deploy flow** — Priority: SHOULD

   * Do manual canary: deploy backend new image to `staging`, run smoke tests, promote to `main`.
   * Acceptance: smoke tests pass.

4. **Rollback plan** — Priority: MUST (critical)

   * Keep ability to revert `main` quickly. Keep DB migrations reversible or use feature flags for score application.
   * Acceptance: documented rollback steps in `docs/runbook.md`.

---

# Phase 7 — Demo, docs & handoff (MUST → NICE)

1. **Demo script** — Priority: MUST

   * `docs/demo_script.md` (exact steps to run services, simulate events). Include curl commands and expected responses.
   * Acceptance: following steps reproduces demo locally.

2. **Snapshot & export** — Priority: MUST

   * `scripts/export_snapshot.py` dumps `scores` + last `events`. Include in release branch.
   * Acceptance: snapshot file created.

3. **Handoff docs** — Priority: SHOULD

   * `docs/handoff.md`, `docs/legal.md` for ToS and scraping legality.
   * Acceptance: new developer can run local dev from docs.

---

# Cross-cutting tasks (ongoing, MUST)

1. **Logging format & correlation IDs**

   * Add structured logs with `request_id` on each pipeline request. Correlate across services.

2. **Observability**

   * Add metrics endpoints (`/metrics` or Prometheus) and log LLM call counts.

3. **Backups & retention**

   * Daily DB backup, snapshot retention policy, clear data retention doc.

4. **Data privacy**

   * Do not store raw scraped HTML permanently. Document retention windows in `docs/legal.md`.

---

# PR Template (paste into each PR description)

```
## Summary
Short description of change.

## Files changed
- list of files

## Acceptance criteria (from issue)
- [ ] Acceptance 1
- [ ] Acceptance 2

## Tests
- [ ] Unit tests added/updated
- [ ] Integration tests (if applicable)

## How to run locally
1. commands...

## Notes
Security, migration notes, known caveats.
```

---

# Issue Template (feature) — quick copy

```
### Title: [feature] short title

#### Description
What, why.

#### Tasks
- [ ] Task 1
- [ ] Task 2

#### Acceptance criteria
- Criterion 1
- Criterion 2

#### Tests
- Tests to add

#### Risk & rollback
- Risk summary
- Rollback step
```